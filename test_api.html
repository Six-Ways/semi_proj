<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>半导体物理与器件 - API测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">半导体物理与器件 - API测试</h1>
            <p class="text-gray-600 mt-2">测试Python后端API与前端可视化集成</p>
        </header>

        <main>
            <section class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">费米-狄拉克分布函数</h2>
                <p class="text-gray-700 mb-4">电子在能级中的分布遵循费米-狄拉克统计：</p>
                <div class="bg-gray-100 p-4 rounded mb-4 text-center">
                    <span class="font-mono">f(E) = 1 / (1 + e^((E-E<sub>F</sub>)/kT))</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="Ef" class="block text-sm font-medium text-gray-700 mb-1">
                            费米能级 (Ef): <span id="EfValue">0.000</span> eV
                        </label>
                        <input type="range" id="Ef" min="-0.5" max="0.5" step="0.01" value="0" 
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                    <div>
                        <label for="kT" class="block text-sm font-medium text-gray-700 mb-1">
                            热能 (kT): <span id="kTValue">0.025</span> eV
                        </label>
                        <input type="range" id="kT" min="0.01" max="0.1" step="0.001" value="0.025" 
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-medium">可视化图表</h3>
                        <button id="updateBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            更新图表
                        </button>
                    </div>
                    <div id="loadingIndicator" class="hidden text-center py-4">
                        <p class="text-gray-500">正在从API获取数据...</p>
                    </div>
                    <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                        <span id="errorText"></span>
                    </div>
                    <canvas id="fermiChart" width="400" height="200"></canvas>
                </div>
                
                <div class="text-sm text-gray-600">
                    <p>费米-狄拉克分布函数描述了在热平衡状态下，能量为E的态被电子占据的概率。</p>
                </div>
            </section>
            
            <section class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">API状态</h2>
                <div id="apiStatus" class="p-4 rounded bg-gray-100">
                    <p class="text-gray-600">点击"检查API状态"按钮测试后端连接</p>
                </div>
                <button id="checkApiBtn" class="mt-4 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    检查API状态
                </button>
            </section>
        </main>
    </div>

    <script>
        // 初始化图表
        const ctx = document.getElementById('fermiChart').getContext('2d');
        let fermiChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '费米-狄拉克分布',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '能量 (eV)'
                        },
                        min: -0.5,
                        max: 0.5
                    },
                    y: {
                        title: {
                            display: true,
                            text: '占据概率'
                        },
                        min: -0.1,
                        max: 1.1
                    }
                }
            }
        });

        // 更新滑块值显示
        document.getElementById('Ef').addEventListener('input', function() {
            document.getElementById('EfValue').textContent = parseFloat(this.value).toFixed(3);
        });

        document.getElementById('kT').addEventListener('input', function() {
            document.getElementById('kTValue').textContent = parseFloat(this.value).toFixed(3);
        });

        // 从API获取数据并更新图表
        async function updateChart() {
            const Ef = parseFloat(document.getElementById('Ef').value);
            const kT = parseFloat(document.getElementById('kT').value);
            
            // 显示加载指示器
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            
            try {
                const response = await fetch('http://localhost:8000/api/math/fermi-function', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        function_type: 'fermi_dirac',
                        parameters: {
                            Ef: Ef,
                            kT: kT,
                            x_min: -0.5,
                            x_max: 0.5,
                            num_points: 100
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // 更新图表
                fermiChart.data.labels = data.x;
                fermiChart.data.datasets[0].data = data.y;
                fermiChart.update();
                
            } catch (error) {
                // 显示错误消息
                document.getElementById('errorText').textContent = `错误: ${error.message}`;
                document.getElementById('errorMessage').classList.remove('hidden');
                console.error('Error fetching data:', error);
                
                // 在控制台输出更多调试信息
                console.log('请求URL:', 'http://localhost:8000/api/math/fermi-function');
                console.log('请求参数:', {
                    function_type: 'fermi_dirac',
                    parameters: {
                        Ef: Ef,
                        kT: kT,
                        x_min: -0.5,
                        x_max: 0.5,
                        num_points: 100
                    }
                });
            } finally {
                // 隐藏加载指示器
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        // 检查API状态
        async function checkApiStatus() {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.innerHTML = '<p class="text-gray-600">正在检查API状态...</p>';
            
            try {
                const response = await fetch('http://localhost:8000/');
                const data = await response.json();
                
                statusDiv.innerHTML = `
                    <div class="text-green-700">
                        <p class="font-semibold">API连接成功!</p>
                        <p>消息: ${data.message}</p>
                        <p class="text-sm mt-2">状态码: ${response.status}</p>
                    </div>
                `;
                statusDiv.className = 'p-4 rounded bg-green-100 border border-green-400';
                
                // API可用时，自动更新图表
                updateChart();
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="text-red-700">
                        <p class="font-semibold">API连接失败!</p>
                        <p>错误: ${error.message}</p>
                        <p class="text-sm mt-2">请确保后端服务器在 http://localhost:8000 上运行</p>
                        <p class="text-xs mt-2">详细错误信息已输出到控制台，请按F12查看</p>
                    </div>
                `;
                statusDiv.className = 'p-4 rounded bg-red-100 border border-red-400';
                console.error('API status check failed:', error);
                console.log('尝试连接的URL:', 'http://localhost:8000/');
                console.log('当前页面URL:', window.location.href);
            }
        }

        // 添加事件监听器
        document.getElementById('updateBtn').addEventListener('click', updateChart);
        document.getElementById('checkApiBtn').addEventListener('click', checkApiStatus);
        
        // 页面加载时检查API状态
        window.addEventListener('load', checkApiStatus);
    </script>
</body>
</html>